<!DOCTYPE html>
<!-- saved from url=(0062)file:///Users/sun/Downloads/spiritual-survey-fixe_2%20(1).html -->
<html lang="zh-TW"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>靈性修養問卷生成與分析系統 - 最終修復版</title>
    <style>
        /* 重置和基礎樣式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 載入狀態 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 頁面切換 */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
        }

        /* 導航欄 */
        .navbar {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2563eb;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        /* 按鈕樣式 */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #b45309;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        /* 編輯頁面佈局 */
        .editor-layout {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 2rem;
            height: calc(100vh - 200px);
        }

        .editor-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .panel-content {
            padding: 1.5rem;
            height: calc(100% - 80px);
            overflow-y: auto;
        }

        /* 分類樹 */
        .category-layer {
            margin-bottom: 2rem;
        }

        .category-layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .category-layer-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .category-node {
            margin-bottom: 0.5rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .category-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .category-name {
            font-weight: 500;
            flex: 1;
        }

        .question-count {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
            min-width: 24px;
            text-align: center;
        }

        .category-actions {
            display: flex;
            gap: 0.25rem;
        }

        .category-children {
            margin-left: 1rem;
            margin-top: 0.5rem;
        }

        /* 題目列表 */
        .question-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-input.error {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
        }

        .question-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: move;
            transition: all 0.2s;
        }

        .question-item:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-color: #d1d5db;
        }

        .question-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .question-content {
            flex: 1;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .question-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.75rem;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .question-categories {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .religious-tag {
            background: #fef3c7;
            color: #92400e;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .question-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
        }

        .drag-handle {
            cursor: grab;
            color: #9ca3af;
            font-weight: bold;
            padding: 0.25rem;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* 預覽面板 */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .preview-info {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .preview-intro {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .preview-question {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .question-number {
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .scale-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .scale-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scale-option:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .scale-option input[type="radio"] {
            margin: 0;
        }

        .scale-label {
            font-size: 0.875rem;
        }

        /* 模態框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* 表單樣式 */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
        }

        /* 分類組 */
        .category-group {
            margin-bottom: 1.5rem;
        }

        .category-group h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        /* 作答頁面 */
        .survey-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .survey-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .survey-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .survey-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        .survey-content {
            padding: 2rem;
        }

        .survey-intro {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0 8px 8px 0;
        }

        .survey-question {
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.2s;
        }

        .survey-question:hover {
            border-color: #d1d5db;
        }

        .survey-question-number {
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
        }

        .survey-question-text {
            font-size: 1rem;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .survey-scale {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        .survey-scale-option {
            text-align: center;
            padding: 0.75rem 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .survey-scale-option:hover {
            border-color: #2563eb;
            background: #eff6ff;
            transform: translateY(-1px);
        }

        .survey-scale-option.selected {
            border-color: #2563eb;
            background: #2563eb;
            color: white;
            transform: translateY(-1px);
        }

        .survey-scale-value {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .survey-scale-label {
            font-size: 0.75rem;
            line-height: 1.2;
        }

        /* 個人資料表單 */
        .demographics-form {
            background: #f9fafb;
            border-radius: 8px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid #e5e7eb;
        }

        .demographics-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #374151;
        }

        /* 結果分析 */
        .results-container {
            margin-top: 2rem;
            padding: 2rem;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .results-subtitle {
            color: #6b7280;
            font-size: 1.125rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .result-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
        }

        .dimension-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f3f4f6;
            border-radius: 6px;
        }

        .dimension-name {
            font-weight: 500;
        }

        .dimension-value {
            font-weight: bold;
            color: #2563eb;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .chart-canvas {
            width: 100%;
            height: 300px;
        }

        /* 建議區塊 */
        .suggestions {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .suggestions-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
        }

        .suggestion-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }

        .suggestion-dimension {
            font-weight: 600;
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .suggestion-text {
            line-height: 1.6;
            color: #4b5563;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #059669;
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.warning {
            background: #d97706;
        }

        .toast.info {
            background: #2563eb;
        }

        /* 統計資訊 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }



        /* 進度條 */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            transition: width 0.3s ease;
            border-radius: 4px;
        }


        /* 保存選項面板 */
        .save-options {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .save-options-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e40af;
        }

        .save-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* 隱藏類 */
        .hidden {
            display: none !important;
        }

        .success-message {
            color: #059669;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* 空狀態 */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* 響應式設計 */
        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 250px 1fr 350px;
            }
        }

        @media (max-width: 768px) {
            .editor-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .editor-panel {
                height: 400px;
            }

            .nav-content {
                flex-direction: column;
                gap: 1rem;
            }

            .question-controls {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .survey-scale {
                grid-template-columns: repeat(3, 1fr);
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .save-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .survey-content {
                padding: 1rem;
            }

            .survey-scale {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        /* 工具提示 */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- 載入覆蓋層 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>



    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-title">靈性修養問卷系統 </div>
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="showPage(&#39;editor&#39;)">問卷編輯</button>
                <button class="btn btn-secondary" onclick="showPage(&#39;survey&#39;)">問卷作答</button>
            </div>
        </div>
    </nav>

    <!-- 編輯頁面 -->
    <div id="editor-page" class="page active">
        <div class="container">
            <!-- 統計資訊 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stats-categories">33</div>
                    <div class="stat-label">分類數量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stats-questions">15</div>
                    <div class="stat-label">題目數量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stats-versions">4</div>
                    <div class="stat-label">版本數量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stats-responses">0</div>
                    <div class="stat-label">回覆數量</div>
                </div>
            </div>

            <!-- 編輯器佈局 -->
            <div class="editor-layout">
                <!-- 左側：分類樹 -->
                <div class="editor-panel">
                    <div class="panel-header">
                        <div class="panel-title">分類管理</div>
                        <button class="btn btn-small btn-primary" onclick="showCategoryModal()">新增分類</button>
                    </div>
                    <div class="panel-content">
                        <div id="category-tree">
                    <div class="category-layer fade-in">
                        <div class="category-layer-header">
                            <h3>靈性修養七面向</h3>
                            <button class="btn-icon tooltip" onclick="showCategoryModal(&#39;FACETS_7&#39;)" data-tooltip="新增分類">
                                <span>+</span>
                            </button>
                        </div>
                        <div class="category-layer-content">
                            
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">起心動念</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-1&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-1&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">後設思考</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-2&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-2&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">意義追尋</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-3&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-3&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">人際靈修</span>
                            <span class="question-count">4</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-4&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-4&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">物質與環境</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-5&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-5&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">與超越者的連結</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-6&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-6&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">生活形態與全人健康</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;facet-7&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;facet-7&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                        </div>
                    </div>
                
                    <div class="category-layer fade-in">
                        <div class="category-layer-header">
                            <h3>靈性健康十核心指標</h3>
                            <button class="btn-icon tooltip" onclick="showCategoryModal(&#39;INDICATORS_10&#39;)" data-tooltip="新增分類">
                                <span>+</span>
                            </button>
                        </div>
                        <div class="category-layer-content">
                            
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">人格統整</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-1&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-1&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">追求真理的後設反思</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-2&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-2&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">意義與目的</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-3&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-3&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">愛與同理</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-4&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-4&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">寬恕與和解</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-5&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-5&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">感恩與喜樂</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-6&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-6&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">財物倫理與靈修</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-7&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-7&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">惜物與共生</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-8&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-8&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">信仰與連結</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-9&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-9&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">宗教信仰與靈性修養</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;indicator-10&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;indicator-10&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                        </div>
                    </div>
                
                    <div class="category-layer fade-in">
                        <div class="category-layer-header">
                            <h3>靈修七原則</h3>
                            <button class="btn-icon tooltip" onclick="showCategoryModal(&#39;PRINCIPLES_7&#39;)" data-tooltip="新增分類">
                                <span>+</span>
                            </button>
                        </div>
                        <div class="category-layer-content">
                            
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">在每一個人身上看見神、看見佛、看見人</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-1&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-1&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">第一個去愛、第一個去給</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-2&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-2&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">給人信心、給人希望、給人歡喜、給人方便</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-3&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-3&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">緩於發怒、敏於寬恕、勇於道歉、時時感恩</span>
                            <span class="question-count">3</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-4&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-4&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">連結神聖、追求意義、擇善固執、不變隨緣</span>
                            <span class="question-count">1</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-5&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-5&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">役物不役於物，惜物厚生濟世</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-6&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-6&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">誠意正心、戒慎恐懼、後設反思、開放公正</span>
                            <span class="question-count">2</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory(&#39;principle-7&#39;)" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory(&#39;principle-7&#39;)" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                
                            </div>
                        </div>
                        
                    </div>
                
                        </div>
                    </div>
                
                    <div class="category-layer fade-in">
                        <div class="category-layer-header">
                            <h3>日常靈修實踐</h3>
                            <button class="btn-icon tooltip" onclick="showCategoryModal(&#39;PRACTICES&#39;)" data-tooltip="新增分類">
                                <span>+</span>
                            </button>
                        </div>
                        <div class="category-layer-content">
                            
                        </div>
                    </div>
                </div>
                    </div>
                </div>

                <!-- 中間：題目管理 -->
                <div class="editor-panel">
                    <div class="panel-header">
                        <div class="panel-title">題目管理</div>
                        <button class="btn btn-small btn-primary" onclick="showQuestionModal()">新增題目</button>
                    </div>
                    <div class="panel-content">
                        <!-- 搜尋和篩選 -->
                        <div class="question-controls">
                            <div class="form-group">
                                <input type="text" id="question-search" class="form-input" placeholder="搜尋題目..." oninput="renderQuestions()">
                            </div>
                            <div class="form-group">
                                <select id="category-filter" class="form-select" onchange="renderQuestions()"><option value="">所有分類</option><optgroup label="靈性修養七面向"><option value="facet-1">起心動念</option><option value="facet-2">後設思考</option><option value="facet-3">意義追尋</option><option value="facet-4">人際靈修</option><option value="facet-5">物質與環境</option><option value="facet-6">與超越者的連結</option><option value="facet-7">生活形態與全人健康</option></optgroup><optgroup label="靈性健康十核心指標"><option value="indicator-1">人格統整</option><option value="indicator-2">追求真理的後設反思</option><option value="indicator-3">意義與目的</option><option value="indicator-4">愛與同理</option><option value="indicator-5">寬恕與和解</option><option value="indicator-6">感恩與喜樂</option><option value="indicator-7">財物倫理與靈修</option><option value="indicator-8">惜物與共生</option><option value="indicator-9">信仰與連結</option><option value="indicator-10">宗教信仰與靈性修養</option></optgroup><optgroup label="靈修七原則"><option value="principle-1">在每一個人身上看見神、看見佛、看見人</option><option value="principle-2">第一個去愛、第一個去給</option><option value="principle-3">給人信心、給人希望、給人歡喜、給人方便</option><option value="principle-4">緩於發怒、敏於寬恕、勇於道歉、時時感恩</option><option value="principle-5">連結神聖、追求意義、擇善固執、不變隨緣</option><option value="principle-6">役物不役於物，惜物厚生濟世</option><option value="principle-7">誠意正心、戒慎恐懼、後設反思、開放公正</option></optgroup></select>
                            </div>
                            <div class="form-group">
                                <select id="religious-filter" class="form-select" onchange="renderQuestions()">
                                    <option value="">所有題目</option>
                                    <option value="religious">宗教性</option>
                                    <option value="non-religious">非宗教性</option>
                                </select>
                            </div>
                        </div>

                        <!-- 題目列表 -->
                        <div id="question-list">
                    <div class="question-item fade-in" draggable="true" data-question-id="q-001">
                        <div class="question-content">
                            <div class="question-text">我能夠覺察自己內心的想法和動機</div>
                            <div class="question-meta">
                                <span class="question-categories">起心動念, 人格統整</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-001&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-001&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-002">
                        <div class="question-content">
                            <div class="question-text">我會反思自己的行為是否符合內心的價值觀</div>
                            <div class="question-meta">
                                <span class="question-categories">後設思考, 追求真理的後設反思, 誠意正心、戒慎恐懼、後設反思、開放公正</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-002&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-002&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-003">
                        <div class="question-content">
                            <div class="question-text">我清楚知道自己人生的目標和意義</div>
                            <div class="question-meta">
                                <span class="question-categories">意義追尋, 意義與目的</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-003&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-003&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-004">
                        <div class="question-content">
                            <div class="question-text">我能夠真誠地關愛他人</div>
                            <div class="question-meta">
                                <span class="question-categories">人際靈修, 愛與同理, 在每一個人身上看見神、看見佛、看見人, 第一個去愛、第一個去給</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-004&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-004&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-005">
                        <div class="question-content">
                            <div class="question-text">我會原諒曾經傷害過我的人</div>
                            <div class="question-meta">
                                <span class="question-categories">人際靈修, 寬恕與和解, 緩於發怒、敏於寬恕、勇於道歉、時時感恩</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-005&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-005&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-006">
                        <div class="question-content">
                            <div class="question-text">我對生活中的美好事物心存感激</div>
                            <div class="question-meta">
                                <span class="question-categories">感恩與喜樂, 緩於發怒、敏於寬恕、勇於道歉、時時感恩</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-006&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-006&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-007">
                        <div class="question-content">
                            <div class="question-text">我會合理使用金錢和物質資源</div>
                            <div class="question-meta">
                                <span class="question-categories">物質與環境, 財物倫理與靈修, 役物不役於物，惜物厚生濟世</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-007&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-007&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-008">
                        <div class="question-content">
                            <div class="question-text">我關心環境保護和永續發展</div>
                            <div class="question-meta">
                                <span class="question-categories">物質與環境, 惜物與共生, 役物不役於物，惜物厚生濟世</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-008&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-008&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-009">
                        <div class="question-content">
                            <div class="question-text">我會主動幫助需要協助的人</div>
                            <div class="question-meta">
                                <span class="question-categories">人際靈修, 第一個去愛、第一個去給, 給人信心、給人希望、給人歡喜、給人方便</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-009&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-009&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-010">
                        <div class="question-content">
                            <div class="question-text">我能夠保持內心的平靜和安定</div>
                            <div class="question-meta">
                                <span class="question-categories">生活形態與全人健康, 人格統整</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-010&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-010&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-011">
                        <div class="question-content">
                            <div class="question-text">我會透過祈禱或冥想與神聖力量連結</div>
                            <div class="question-meta">
                                <span class="question-categories">與超越者的連結, 信仰與連結</span>
                                <span class="religious-tag">宗教性</span>
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-011&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-011&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-012">
                        <div class="question-content">
                            <div class="question-text">我的宗教信仰為我的生活帶來指引</div>
                            <div class="question-meta">
                                <span class="question-categories">與超越者的連結, 宗教信仰與靈性修養</span>
                                <span class="religious-tag">宗教性</span>
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-012&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-012&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-013">
                        <div class="question-content">
                            <div class="question-text">我會定期進行自我反省</div>
                            <div class="question-meta">
                                <span class="question-categories">後設思考, 追求真理的後設反思, 誠意正心、戒慎恐懼、後設反思、開放公正</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-013&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-013&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-014">
                        <div class="question-content">
                            <div class="question-text">我能夠在困難中找到成長的機會</div>
                            <div class="question-meta">
                                <span class="question-categories">意義追尋, 意義與目的, 連結神聖、追求意義、擇善固執、不變隨緣</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-014&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-014&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                
                    <div class="question-item fade-in" draggable="true" data-question-id="q-015">
                        <div class="question-content">
                            <div class="question-text">我會為自己的錯誤真誠道歉</div>
                            <div class="question-meta">
                                <span class="question-categories">人際靈修, 緩於發怒、敏於寬恕、勇於道歉、時時感恩</span>
                                
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion(&#39;q-015&#39;)" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion(&#39;q-015&#39;)" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                </div>
                    </div>
                </div>

                <!-- 右側：預覽和版本管理 -->
                <div class="editor-panel">
                    <div class="panel-header">
                        <div class="panel-title">問卷預覽</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label style="font-size: 0.875rem;" class="tooltip" data-tooltip="隨機化題目順序">
                                <input type="checkbox" id="toggle-preview-random" onchange="togglePreviewMode()"> 隨機化
                            </label>
                            <button class="btn btn-small btn-success" onclick="generateSurvey()">生成問卷</button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div id="preview-pane">
                <div class="preview-header">
                    <h3>問卷預覽</h3>
                    <div class="preview-info">
                        <span>共 15 題</span>
                        <span>模式: 分類順序</span>
                    </div>
                </div>
                <div class="preview-intro">
                    您是否曾想過：我的行程滿檔，為什麼內心深處仍會感到空虛？不太確定人生的目標與意義感？我的內心與人際關係為何常有一些衝突不和諧的地方？想處理這些問題，讓自己過得更充實滿足，卻不知道從哪裡開始？<br><br>——或許，是時候來照顧自己的「靈性健康」了！<br><br>靈性健康指的是一個人內在是否安定、明白生命的意義，能與自己、他人、自然及更大的生命連結，建立和諧的關係。它讓我們在困難中不迷失，在日常中找回平靜與希望。
                </div>
                <div class="preview-questions">
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">1.</div>
                            <div class="question-text">我能夠覺察自己內心的想法和動機</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-001" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">2.</div>
                            <div class="question-text">我會反思自己的行為是否符合內心的價值觀</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-002" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">3.</div>
                            <div class="question-text">我清楚知道自己人生的目標和意義</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-003" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">4.</div>
                            <div class="question-text">我能夠真誠地關愛他人</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-004" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">5.</div>
                            <div class="question-text">我會原諒曾經傷害過我的人</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-005" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">6.</div>
                            <div class="question-text">我對生活中的美好事物心存感激</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-006" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">7.</div>
                            <div class="question-text">我會合理使用金錢和物質資源</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-007" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">8.</div>
                            <div class="question-text">我關心環境保護和永續發展</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-008" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">9.</div>
                            <div class="question-text">我會主動幫助需要協助的人</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-009" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">10.</div>
                            <div class="question-text">我能夠保持內心的平靜和安定</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-010" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">11.</div>
                            <div class="question-text">我會透過祈禱或冥想與神聖力量連結</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-011" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">12.</div>
                            <div class="question-text">我的宗教信仰為我的生活帶來指引</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-012" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">13.</div>
                            <div class="question-text">我會定期進行自我反省</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-013" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">14.</div>
                            <div class="question-text">我能夠在困難中找到成長的機會</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-014" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                        <div class="preview-question fade-in">
                            <div class="question-number">15.</div>
                            <div class="question-text">我會為自己的錯誤真誠道歉</div>
                            <div class="scale-options">
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="1" disabled="">
                                        <span class="scale-label">1. 完全不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="2" disabled="">
                                        <span class="scale-label">2. 很不符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="3" disabled="">
                                        <span class="scale-label">3. 不太符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="4" disabled="">
                                        <span class="scale-label">4. 有點符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="5" disabled="">
                                        <span class="scale-label">5. 很符合</span>
                                    </label>
                                
                                    <label class="scale-option">
                                        <input type="radio" name="preview-qq-015" value="6" disabled="">
                                        <span class="scale-label">6. 完全符合</span>
                                    </label>
                                
                            </div>
                        </div>
                    
                </div>
            </div>
                        
                  
             

                

    <!-- 作答頁面 -->
    <div id="survey-page" class="page">
        <div class="survey-container">
            <div class="survey-header">
                <div class="survey-title">靈性修養問卷</div>
                <div class="survey-subtitle">探索您的內在世界</div>
            </div>
            
            <div class="survey-content">
                <!-- 引導語 -->
                <div id="intro-text" class="survey-intro"></div>

                <!-- 進度條 -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>

                <!-- 問卷表單 -->
                <form id="answer-form">
                    <div id="survey-questions"></div>
                </form>

                <!-- 個人資料表單 -->
                <div id="profile-form" class="demographics-form hidden">
                    <div class="demographics-title">個人基本資料</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">姓名 *</label>
                            <input type="text" name="name" class="form-input" required="">
                            <div class="error-message" id="name-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">生日 *</label>
                            <input type="date" name="birth" class="form-input" required="">
                            <div class="error-message" id="birth-error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">性別 *</label>
                            <select name="gender" class="form-select" required="">
                                <option value="">請選擇</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="error-message" id="gender-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">國籍 *</label>
                            <input type="text" name="nationality" class="form-input" required="">
                            <div class="error-message" id="nationality-error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">目前居住城市 *</label>
                            <input type="text" name="city" class="form-input" required="">
                            <div class="error-message" id="city-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">職業 *</label>
                            <input type="text" name="profession" class="form-input" required="">
                            <div class="error-message" id="profession-error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">教育程度 *</label>
                            <select name="education" class="form-select" required="">
                                <option value="">請選擇</option>
                                <option value="國小及以下">國小及以下</option>
                                <option value="國中">國中</option>
                                <option value="高中職">高中職</option>
                                <option value="專科">專科</option>
                                <option value="大學">大學</option>
                                <option value="碩士">碩士</option>
                                <option value="博士">博士</option>
                            </select>
                            <div class="error-message" id="education-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">婚姻狀況 *</label>
                            <select name="marital" class="form-select" required="">
                                <option value="">請選擇</option>
                                <option value="未婚">未婚</option>
                                <option value="已婚">已婚</option>
                                <option value="離婚">離婚</option>
                                <option value="喪偶">喪偶</option>
                            </select>
                            <div class="error-message" id="marital-error"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">宗教信仰 *</label>
                            <select name="religion" class="form-select" required="">
                                <option value="">請選擇</option>
                                <option value="無宗教信仰">無宗教信仰</option>
                                <option value="佛教">佛教</option>
                                <option value="道教">道教</option>
                                <option value="基督教">基督教</option>
                                <option value="天主教">天主教</option>
                                <option value="伊斯蘭教">伊斯蘭教</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="error-message" id="religion-error"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">居住狀況 *</label>
                            <select name="living" class="form-select" required="">
                                <option value="">請選擇</option>
                                <option value="獨居">獨居</option>
                                <option value="與親屬同住">與親屬同住</option>
                                <option value="與非親屬同住">與非親屬同住</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="error-message" id="living-error"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">檢測日期 *</label>
                        <input type="date" name="testDate" class="form-input" required="">
                        <div class="error-message" id="testDate-error"></div>
                    </div>
                </div>

          

          
          
    <!-- 分類模態框 -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">分類管理</div>
                <button class="modal-close" onclick="hideAllModals()">×</button>
            </div>
            <div class="modal-body">
                <form id="category-form" onsubmit="saveCategoryFromModal(event)">
                    <div class="form-group">
                        <label class="form-label">分類名稱 *</label>
                        <input type="text" name="name" id="category-name" class="form-input" required="">
                        <div class="error-message" id="category-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">分類層級 *</label>
                        <select name="layer" id="category-layer" class="form-select" required="">
                            <option value="">請選擇</option>
                        </select>
                        <div class="error-message" id="category-layer-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">父分類</label>
                        <select name="parent" id="category-parent" class="form-select">
                            <option value="">無（根分類）</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAllModals()">取消</button>
                <button type="submit" form="category-form" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>

    <!-- 題目模態框 -->
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">題目管理</div>
                <button class="modal-close" onclick="hideAllModals()">×</button>
            </div>
            <div class="modal-body">
                <form id="question-form" onsubmit="saveQuestionFromModal(event)">
                    <div class="form-group">
                        <label class="form-label">題目內容 *</label>
                        <textarea name="text" id="q-text" class="form-input" rows="3" required=""></textarea>
                        <div class="error-message" id="question-text-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">所屬分類 *</label>
                        <div id="question-categories"></div>
                        <div class="error-message" id="question-categories-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="isReligious" id="q-is-religious">
                            <span>宗教性題目</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideAllModals()">取消</button>
                <button type="submit" form="question-form" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>

  

    <script>
        'use strict';

        // ===== 全域常數和配置 =====
        
        const CONFIG = {
            // 分類層級類型
            LAYER_TYPES: {
                FACETS_7: 'FACETS_7',
                INDICATORS_10: 'INDICATORS_10',
                PRINCIPLES_7: 'PRINCIPLES_7',
                PRACTICES: 'PRACTICES'
            },
            
            // 分類層級名稱
            LAYER_NAMES: {
                FACETS_7: '靈性修養七面向',
                INDICATORS_10: '靈性健康十核心指標',
                PRINCIPLES_7: '靈修七原則',
                PRACTICES: '日常靈修實踐'
            },
            
            // 6分量表選項
            SCALE_OPTIONS: [
                { value: 1, label: '完全不符合' },
                { value: 2, label: '很不符合' },
                { value: 3, label: '不太符合' },
                { value: 4, label: '有點符合' },
                { value: 5, label: '很符合' },
                { value: 6, label: '完全符合' }
            ],
            
            // 固定引導語
            SURVEY_INTRO_TEXT: `您是否曾想過：我的行程滿檔，為什麼內心深處仍會感到空虛？不太確定人生的目標與意義感？我的內心與人際關係為何常有一些衝突不和諧的地方？想處理這些問題，讓自己過得更充實滿足，卻不知道從哪裡開始？

——或許，是時候來照顧自己的「靈性健康」了！

靈性健康指的是一個人內在是否安定、明白生命的意義，能與自己、他人、自然及更大的生命連結，建立和諧的關係。它讓我們在困難中不迷失，在日常中找回平靜與希望。`,
            
            // 儲存鍵值
            STORAGE_KEYS: {
                CATEGORIES: 'sss.categories',
                QUESTIONS: 'sss.questions',
                VERSIONS: 'sss.versions',
                RESPONSES: 'sss.responses',
                SETTINGS: 'sss.settings',
                PARTIAL_ANSWERS: 'sss.partial_answers'
            },
            
            // 自動保存間隔（毫秒）
            AUTO_SAVE_INTERVAL: 30000,
            
            // Toast 顯示時間
            TOAST_DURATION: 3000
        };

        // 初始分類資料（包含日常靈修實踐）
        const INITIAL_CATEGORIES = [
            // 靈性修養七面向
            { id: 'facet-1', layer: 'FACETS_7', name: '起心動念', parentId: null, order: 1 },
            { id: 'facet-2', layer: 'FACETS_7', name: '後設思考', parentId: null, order: 2 },
            { id: 'facet-3', layer: 'FACETS_7', name: '意義追尋', parentId: null, order: 3 },
            { id: 'facet-4', layer: 'FACETS_7', name: '人際靈修', parentId: null, order: 4 },
            { id: 'facet-5', layer: 'FACETS_7', name: '物質與環境', parentId: null, order: 5 },
            { id: 'facet-6', layer: 'FACETS_7', name: '與超越者的連結', parentId: null, order: 6 },
            { id: 'facet-7', layer: 'FACETS_7', name: '生活形態與全人健康', parentId: null, order: 7 },
            
            // 靈性健康十核心指標
            { id: 'indicator-1', layer: 'INDICATORS_10', name: '人格統整', parentId: null, order: 1 },
            { id: 'indicator-2', layer: 'INDICATORS_10', name: '追求真理的後設反思', parentId: null, order: 2 },
            { id: 'indicator-3', layer: 'INDICATORS_10', name: '意義與目的', parentId: null, order: 3 },
            { id: 'indicator-4', layer: 'INDICATORS_10', name: '愛與同理', parentId: null, order: 4 },
            { id: 'indicator-5', layer: 'INDICATORS_10', name: '寬恕與和解', parentId: null, order: 5 },
            { id: 'indicator-6', layer: 'INDICATORS_10', name: '感恩與喜樂', parentId: null, order: 6 },
            { id: 'indicator-7', layer: 'INDICATORS_10', name: '財物倫理與靈修', parentId: null, order: 7 },
            { id: 'indicator-8', layer: 'INDICATORS_10', name: '惜物與共生', parentId: null, order: 8 },
            { id: 'indicator-9', layer: 'INDICATORS_10', name: '信仰與連結', parentId: null, order: 9, isReligious: true },
            { id: 'indicator-10', layer: 'INDICATORS_10', name: '宗教信仰與靈性修養', parentId: null, order: 10, isReligious: true },
            
            // 靈修七原則
            { id: 'principle-1', layer: 'PRINCIPLES_7', name: '在每一個人身上看見神、看見佛、看見人', parentId: null, order: 1 },
            { id: 'principle-2', layer: 'PRINCIPLES_7', name: '第一個去愛、第一個去給', parentId: null, order: 2 },
            { id: 'principle-3', layer: 'PRINCIPLES_7', name: '給人信心、給人希望、給人歡喜、給人方便', parentId: null, order: 3 },
            { id: 'principle-4', layer: 'PRINCIPLES_7', name: '緩於發怒、敏於寬恕、勇於道歉、時時感恩', parentId: null, order: 4 },
            { id: 'principle-5', layer: 'PRINCIPLES_7', name: '連結神聖、追求意義、擇善固執、不變隨緣', parentId: null, order: 5 },
            { id: 'principle-6', layer: 'PRINCIPLES_7', name: '役物不役於物，惜物厚生濟世', parentId: null, order: 6 },
            { id: 'principle-7', layer: 'PRINCIPLES_7', name: '誠意正心、戒慎恐懼、後設反思、開放公正', parentId: null, order: 7 },
            
            // 日常靈修實踐（新增）
            { id: 'practice-1', layer: 'PRACTICES', name: '冥想與靜心', parentId: null, order: 1 },
            { id: 'practice-2', layer: 'PRACTICES', name: '祈禱與禮拜', parentId: null, order: 2 },
            { id: 'practice-3', layer: 'PRACTICES', name: '閱讀與學習', parentId: null, order: 3 },
            { id: 'practice-4', layer: 'PRACTICES', name: '服務與奉獻', parentId: null, order: 4 },
            { id: 'practice-5', layer: 'PRACTICES', name: '自然連結', parentId: null, order: 5 }
        ];

        // 初始題目資料
        const INITIAL_QUESTIONS = [
            { id: 'q-001', text: '我能夠覺察自己內心的想法和動機', categoryIds: ['facet-1', 'indicator-1'], isReligious: false, order: 1 },
            { id: 'q-002', text: '我會反思自己的行為是否符合內心的價值觀', categoryIds: ['facet-2', 'indicator-2', 'principle-7'], isReligious: false, order: 2 },
            { id: 'q-003', text: '我清楚知道自己人生的目標和意義', categoryIds: ['facet-3', 'indicator-3'], isReligious: false, order: 3 },
            { id: 'q-004', text: '我能夠真誠地關愛他人', categoryIds: ['facet-4', 'indicator-4', 'principle-1', 'principle-2'], isReligious: false, order: 4 },
            { id: 'q-005', text: '我會原諒曾經傷害過我的人', categoryIds: ['facet-4', 'indicator-5', 'principle-4'], isReligious: false, order: 5 },
            { id: 'q-006', text: '我對生活中的美好事物心存感激', categoryIds: ['indicator-6', 'principle-4'], isReligious: false, order: 6 },
            { id: 'q-007', text: '我會合理使用金錢和物質資源', categoryIds: ['facet-5', 'indicator-7', 'principle-6'], isReligious: false, order: 7 },
            { id: 'q-008', text: '我關心環境保護和永續發展', categoryIds: ['facet-5', 'indicator-8', 'principle-6'], isReligious: false, order: 8 },
            { id: 'q-009', text: '我會主動幫助需要協助的人', categoryIds: ['facet-4', 'principle-2', 'principle-3', 'practice-4'], isReligious: false, order: 9 },
            { id: 'q-010', text: '我能夠保持內心的平靜和安定', categoryIds: ['facet-7', 'indicator-1', 'practice-1'], isReligious: false, order: 10 },
            { id: 'q-011', text: '我會透過祈禱或冥想與神聖力量連結', categoryIds: ['facet-6', 'indicator-9', 'practice-1', 'practice-2'], isReligious: true, order: 11 },
            { id: 'q-012', text: '我的宗教信仰為我的生活帶來指引', categoryIds: ['facet-6', 'indicator-10', 'practice-2'], isReligious: true, order: 12 },
            { id: 'q-013', text: '我會定期進行自我反省', categoryIds: ['facet-2', 'indicator-2', 'principle-7', 'practice-1'], isReligious: false, order: 13 },
            { id: 'q-014', text: '我能夠在困難中找到成長的機會', categoryIds: ['facet-3', 'indicator-3', 'principle-5'], isReligious: false, order: 14 },
            { id: 'q-015', text: '我會為自己的錯誤真誠道歉', categoryIds: ['facet-4', 'principle-4'], isReligious: false, order: 15 },
            { id: 'q-016', text: '我經常閱讀靈性或哲學相關的書籍', categoryIds: ['practice-3'], isReligious: false, order: 16 },
            { id: 'q-017', text: '我喜歡在大自然中尋找內心的平靜', categoryIds: ['practice-5', 'facet-5'], isReligious: false, order: 17 },
            { id: 'q-018', text: '我會定期參與志工服務或慈善活動', categoryIds: ['practice-4', 'principle-2'], isReligious: false, order: 18 }
        ];

        // ===== 全域變數 =====
        
        let appState = {
            currentEditingQuestion: null,
            currentEditingCategory: null,
            currentVersion: null,
            surveyAnswers: {},
            previewMode: 'BY_CATEGORY',
            categories: [],
            questions: [],
            versions: [],
            settings: {},
            autoSaveTimer: null,
            currentResult: null
        };

        // ===== 工具函數 =====
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(date, format = 'YYYY-MM-DD') {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return format
                .replace('YYYY', year)
                .replace('MM', month)
                .replace('DD', day)
                .replace('HH', hours)
                .replace('mm', minutes)
                .replace('ss', seconds);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function downloadFile(data, filename, type = 'application/json') {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function sanitizeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function isEmpty(value) {
            return value === null || value === undefined || 
                   (typeof value === 'string' && value.trim() === '') ||
                   (Array.isArray(value) && value.length === 0) ||
                   (typeof value === 'object' && Object.keys(value).length === 0);
        }

        // ===== 儲存管理 =====
        
        //function getFromStorage(key) {
          //  try {
          //      const data = localStorage.getItem(key);
           //     return data ? JSON.parse(data) : null;
        //    } catch (error) {
        //        console.error('讀取資料失敗:', error);
        //        return null;
         //   }
    //    }

  //      function saveToStorage(key, data) {
 //           try {
 //               localStorage.setItem(key, JSON.stringify(data));
  //              return true;
   //         } catch (error) {
  //              console.error('儲存資料失敗:', error);
   //             showToast('儲存失敗: ' + error.message, 'error');
    //            return false;
  //          }
   //     }

        function getCategories() {
            return getFromStorage(CONFIG.STORAGE_KEYS.CATEGORIES) || [];
        }

        function saveCategories(categories) {
            return saveToStorage(CONFIG.STORAGE_KEYS.CATEGORIES, categories);
        }

        function getQuestions() {
            return getFromStorage(CONFIG.STORAGE_KEYS.QUESTIONS) || [];
        }

        function saveQuestions(questions) {
            return saveToStorage(CONFIG.STORAGE_KEYS.QUESTIONS, questions);
        }

        function getVersions() {
            return getFromStorage(CONFIG.STORAGE_KEYS.VERSIONS) || [];
        }

        function saveVersions(versions) {
            return saveToStorage(CONFIG.STORAGE_KEYS.VERSIONS, versions);
        }

        function getResponses() {
            return getFromStorage(CONFIG.STORAGE_KEYS.RESPONSES) || [];
        }

        function saveResponse(response) {
            const responses = getResponses();
            responses.push(response);
            return saveToStorage(CONFIG.STORAGE_KEYS.RESPONSES, responses);
        }

        function getPartialAnswers() {
            return getFromStorage(CONFIG.STORAGE_KEYS.PARTIAL_ANSWERS) || {};
        }

        function savePartialAnswers(answers) {
            return saveToStorage(CONFIG.STORAGE_KEYS.PARTIAL_ANSWERS, answers);
        }

        // ===== UI 管理 =====
        
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function showToast(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duration);

            return toast;
        }

        function showAutoSaveIndicator(status = 'saved') {
            const indicator = document.getElementById('auto-save-indicator');
            const statusText = document.getElementById('save-status-text');
            
            if (!indicator || !statusText) return;
            
            indicator.className = 'auto-save-indicator show';
            
            switch (status) {
                case 'saving':
                    indicator.classList.add('saving');
                    statusText.textContent = '正在保存...';
                    break;
                case 'saved':
                    indicator.classList.remove('saving', 'error');
                    statusText.textContent = '已自動保存';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    statusText.textContent = '保存失敗';
                    break;
            }
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                
                if (pageId === 'survey') {
                    initSurvey();
                }
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                const firstInput = modal.querySelector('input, textarea, select');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function clearFormErrors(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.querySelectorAll('.error-message').forEach(error => {
                    error.textContent = '';
                });
                form.querySelectorAll('.form-input, .form-select').forEach(input => {
                    input.classList.remove('error');
                });
            }
        }

        function showFormError(fieldName, message) {
            const errorElement = document.getElementById(fieldName + '-error');
            const inputElement = document.querySelector(`[name="${fieldName}"]`);
            
            if (errorElement) {
                errorElement.textContent = message;
            }
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function validateForm(formId, rules) {
            const form = document.getElementById(formId);
            if (!form) return false;

            clearFormErrors(formId);
            let isValid = true;

            const formData = new FormData(form);
            
            for (const [fieldName, rule] of Object.entries(rules)) {
                const value = formData.get(fieldName);
                
                if (rule.required && isEmpty(value)) {
                    showFormError(fieldName, rule.requiredMessage || '此欄位為必填');
                    isValid = false;
                    continue;
                }
                
                if (value && rule.validator && !rule.validator(value)) {
                    showFormError(fieldName, rule.validatorMessage || '格式不正確');
                    isValid = false;
                }
            }

            return isValid;
        }

        // ===== 初始化 =====
        
        async function initApp() {
            try {
                showLoading();
                
                // 檢查是否已有資料
                if (!getCategories().length) {
                    saveCategories(INITIAL_CATEGORIES);
                }
                if (!getQuestions().length) {
                    saveQuestions(INITIAL_QUESTIONS);
                }
                
                // 載入資料
                await loadData();
                
                // 渲染界面
                render();
                
                // 設置檢測日期預設值
                setDefaultTestDate();
                
                // 啟動自動保存
                startAutoSave();
                
                hideLoading();
                showToast('系統初始化完成', 'success');
                
            } catch (error) {
                console.error('應用程式初始化失敗:', error);
                hideLoading();
                showToast('系統初始化失敗: ' + error.message, 'error');
            }
        }

        async function loadData() {
            appState.categories = getCategories();
            appState.questions = getQuestions();
            appState.versions = getVersions();
            appState.settings = getFromStorage(CONFIG.STORAGE_KEYS.SETTINGS) || {};
            appState.previewMode = appState.settings.previewMode || 'BY_CATEGORY';
            
            // 載入部分答案
            const partialAnswers = getPartialAnswers();
            if (Object.keys(partialAnswers).length > 0) {
                appState.surveyAnswers = partialAnswers;
            }
        }

        function render() {
            renderCategoryTree();
            renderQuestions();
            renderPreview();
            renderVersions();
            updateStats();
        }

        // ===== 分類管理 =====
        
        function renderCategoryTree() {
            const container = document.getElementById('category-tree');
            if (!container) return;

            const tree = buildCategoryTree();
            let html = '';

            Object.entries(CONFIG.LAYER_NAMES).forEach(([layerType, layerName]) => {
                const categories = tree[layerType] || [];
                
                html += `
                    <div class="category-layer fade-in">
                        <div class="category-layer-header">
                            <h3>${layerName}</h3>
                            <button class="btn-icon tooltip" onclick="showCategoryModal('${layerType}')" data-tooltip="新增分類">
                                <span>+</span>
                            </button>
                        </div>
                        <div class="category-layer-content">
                            ${renderCategoryNodes(categories)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">📁</div>尚無分類資料</div>';
        }

        function buildCategoryTree() {
            const tree = {};
            
            Object.values(CONFIG.LAYER_TYPES).forEach(layer => {
                tree[layer] = appState.categories
                    .filter(c => c.layer === layer && !c.parentId)
                    .sort((a, b) => a.order - b.order)
                    .map(category => ({
                        ...category,
                        children: getCategoryChildren(category.id)
                    }));
            });
            
            return tree;
        }

        function getCategoryChildren(parentId) {
            return appState.categories
                .filter(c => c.parentId === parentId)
                .sort((a, b) => a.order - b.order);
        }

        function renderCategoryNodes(categories) {
            return categories.map(category => {
                const questionCount = getCategoryQuestionCount(category.id);
                const hasChildren = category.children && category.children.length > 0;
                
                return `
                    <div class="category-node">
                        <div class="category-item">
                            <span class="category-name">${sanitizeHtml(category.name)}</span>
                            <span class="question-count">${questionCount}</span>
                            <div class="category-actions">
                                <button class="btn-icon tooltip" onclick="editCategory('${category.id}')" data-tooltip="編輯">
                                    <span>✏️</span>
                                </button>
                                <button class="btn-icon tooltip" onclick="deleteCategory('${category.id}')" data-tooltip="刪除">
                                    <span>🗑️</span>
                                </button>
                                ${category.layer === 'PRACTICES' ? `
                                    <button class="btn-icon tooltip" onclick="showCategoryModal('${category.layer}', '${category.id}')" data-tooltip="新增子分類">
                                        <span>+</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${hasChildren ? `
                            <div class="category-children">
                                ${renderCategoryNodes(category.children)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getCategoryQuestionCount(categoryId) {
            return appState.questions.filter(q => q.categoryIds.includes(categoryId)).length;
        }

        function showCategoryModal(layer = null, parentId = null) {
            appState.currentEditingCategory = null;
            
            const form = document.getElementById('category-form');
            if (form) {
                form.reset();
                clearFormErrors('category-form');
            }
            
            const layerSelect = document.getElementById('category-layer');
            if (layerSelect) {
                layerSelect.innerHTML = Object.entries(CONFIG.LAYER_NAMES)
                    .map(([value, label]) => `<option value="${value}">${label}</option>`)
                    .join('');
                
                if (layer) {
                    layerSelect.value = layer;
                    layerSelect.disabled = true;
                } else {
                    layerSelect.disabled = false;
                }
            }

            // 設置父分類選項
            const parentSelect = document.getElementById('category-parent');
            if (parentSelect && layer === 'PRACTICES') {
                const practiceCategories = appState.categories.filter(c => c.layer === 'PRACTICES' && !c.parentId);
                parentSelect.innerHTML = '<option value="">無（根分類）</option>' +
                    practiceCategories.map(c => `<option value="${c.id}">${sanitizeHtml(c.name)}</option>`).join('');
                
                if (parentId) {
                    parentSelect.value = parentId;
                }
            }

            showModal('category-modal');
        }

        function editCategory(categoryId) {
            const category = appState.categories.find(c => c.id === categoryId);
            if (!category) {
                showToast('找不到指定的分類', 'error');
                return;
            }

            appState.currentEditingCategory = category;
            
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-layer').value = category.layer;
            document.getElementById('category-layer').disabled = true;

            // 設置父分類
            const parentSelect = document.getElementById('category-parent');
            if (parentSelect) {
                if (category.layer === 'PRACTICES') {
                    const practiceCategories = appState.categories.filter(c => c.layer === 'PRACTICES' && !c.parentId && c.id !== category.id);
                    parentSelect.innerHTML = '<option value="">無（根分類）</option>' +
                        practiceCategories.map(c => `<option value="${c.id}">${sanitizeHtml(c.name)}</option>`).join('');
                    parentSelect.value = category.parentId || '';
                } else {
                    parentSelect.innerHTML = '<option value="">無（根分類）</option>';
                    parentSelect.value = '';
                }
            }

            showModal('category-modal');
        }

        function saveCategoryFromModal(event) {
            event.preventDefault();
            
            const isValid = validateForm('category-form', {
                name: {
                    required: true,
                    requiredMessage: '請輸入分類名稱',
                    validator: (value) => value.trim().length >= 2,
                    validatorMessage: '分類名稱至少需要2個字元'
                },
                layer: {
                    required: true,
                    requiredMessage: '請選擇分類層級'
                }
            });

            if (!isValid) return;

            try {
                showLoading();
                
                const form = document.getElementById('category-form');
                const formData = new FormData(form);
                
                const categoryData = {
                    name: formData.get('name').trim(),
                    layer: formData.get('layer'),
                    parentId: formData.get('parent') || null
                };

                if (appState.currentEditingCategory) {
                    // 更新分類
                    const categories = getCategories();
                    const index = categories.findIndex(c => c.id === appState.currentEditingCategory.id);
                    if (index !== -1) {
                        categories[index] = { ...categories[index], ...categoryData };
                        saveCategories(categories);
                        showToast('分類已更新', 'success');
                    }
                } else {
                    // 新增分類
                    const newCategory = {
                        id: generateId(),
                        ...categoryData,
                        order: getNextCategoryOrder(categoryData.layer, categoryData.parentId)
                    };
                    
                    const categories = getCategories();
                    categories.push(newCategory);
                    saveCategories(categories);
                    showToast('分類已新增', 'success');
                }

                loadData();
                render();
                hideAllModals();

            } catch (error) {
                console.error('儲存分類失敗:', error);
                showToast('儲存分類失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function deleteCategory(categoryId) {
            const category = appState.categories.find(c => c.id === categoryId);
            if (!category) {
                showToast('找不到指定的分類', 'error');
                return;
            }

            const relatedQuestions = appState.questions.filter(q => q.categoryIds.includes(categoryId));
            
            let confirmMessage = `確定要刪除分類「${category.name}」嗎？`;
            if (relatedQuestions.length > 0) {
                confirmMessage += `\n\n此分類被 ${relatedQuestions.length} 個題目使用，刪除後這些題目將失去此分類標記。`;
            }

            if (!confirm(confirmMessage)) return;

            try {
                showLoading();
                
                // 更新相關題目
                const questions = getQuestions();
                questions.forEach(question => {
                    if (question.categoryIds.includes(categoryId)) {
                        question.categoryIds = question.categoryIds.filter(id => id !== categoryId);
                    }
                });
                saveQuestions(questions);

                // 刪除分類
                const categories = getCategories();
                const filtered = categories.filter(c => c.id !== categoryId);
                saveCategories(filtered);
                
                loadData();
                render();
                
                showToast('分類已刪除', 'success');

            } catch (error) {
                console.error('刪除分類失敗:', error);
                showToast('刪除分類失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function getNextCategoryOrder(layer, parentId = null) {
            const siblings = appState.categories.filter(c => 
                c.layer === layer && c.parentId === parentId
            );
            return siblings.length > 0 ? Math.max(...siblings.map(c => c.order)) + 1 : 1;
        }

        // ===== 題目管理 =====
        
        function renderQuestions() {
            const container = document.getElementById('question-list');
            if (!container) return;

            let filteredQuestions = [...appState.questions];

            // 搜尋篩選
            const searchTerm = document.getElementById('question-search')?.value.toLowerCase();
            if (searchTerm) {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.text.toLowerCase().includes(searchTerm)
                );
            }

            // 分類篩選
            const categoryFilter = document.getElementById('category-filter')?.value;
            if (categoryFilter) {
                filteredQuestions = filteredQuestions.filter(q => 
                    q.categoryIds.includes(categoryFilter)
                );
            }

            // 宗教性篩選
            const religiousFilter = document.getElementById('religious-filter')?.value;
            if (religiousFilter === 'religious') {
                filteredQuestions = filteredQuestions.filter(q => q.isReligious);
            } else if (religiousFilter === 'non-religious') {
                filteredQuestions = filteredQuestions.filter(q => !q.isReligious);
            }

            // 排序
            filteredQuestions.sort((a, b) => a.order - b.order);

            const html = filteredQuestions.map(question => {
                const categoryNames = question.categoryIds
                    .map(id => {
                        const category = appState.categories.find(c => c.id === id);
                        return category ? category.name : '';
                    })
                    .filter(name => name)
                    .join(', ');

                return `
                    <div class="question-item fade-in" draggable="true" data-question-id="${question.id}">
                        <div class="question-content">
                            <div class="question-text">${sanitizeHtml(question.text)}</div>
                            <div class="question-meta">
                                <span class="question-categories">${sanitizeHtml(categoryNames)}</span>
                                ${question.isReligious ? '<span class="religious-tag">宗教性</span>' : ''}
                            </div>
                        </div>
                        <div class="question-actions">
                            <button class="btn-icon tooltip" onclick="editQuestion('${question.id}')" data-tooltip="編輯">
                                <span>✏️</span>
                            </button>
                            <button class="btn-icon tooltip" onclick="deleteQuestion('${question.id}')" data-tooltip="刪除">
                                <span>🗑️</span>
                            </button>
                            <span class="drag-handle tooltip" data-tooltip="拖曳排序">⋮⋮</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">❓</div>沒有找到符合條件的題目</div>';
            updateCategoryFilter();
        }

        function updateCategoryFilter() {
            const select = document.getElementById('category-filter');
            if (!select) return;

            const currentValue = select.value;
            let html = '<option value="">所有分類</option>';
            
            Object.entries(CONFIG.LAYER_NAMES).forEach(([layerType, layerName]) => {
                const categories = appState.categories.filter(c => c.layer === layerType);
                if (categories.length > 0) {
                    html += `<optgroup label="${layerName}">`;
                    categories.forEach(category => {
                        html += `<option value="${category.id}">${sanitizeHtml(category.name)}</option>`;
                    });
                    html += '</optgroup>';
                }
            });

            select.innerHTML = html;
            select.value = currentValue;
        }

        function showQuestionModal() {
            appState.currentEditingQuestion = null;
            
            const form = document.getElementById('question-form');
            if (form) {
                form.reset();
                clearFormErrors('question-form');
            }
            
            updateQuestionCategoryOptions();
            showModal('question-modal');
        }

        function editQuestion(questionId) {
            const question = appState.questions.find(q => q.id === questionId);
            if (!question) {
                showToast('找不到指定的題目', 'error');
                return;
            }

            appState.currentEditingQuestion = question;
            
            document.getElementById('q-text').value = question.text;
            document.getElementById('q-is-religious').checked = question.isReligious || false;
            
            updateQuestionCategoryOptions();
            
            // 設置已選擇的分類
            question.categoryIds.forEach(categoryId => {
                const checkbox = document.querySelector(`input[name="categories"][value="${categoryId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            showModal('question-modal');
        }

        function updateQuestionCategoryOptions() {
            const container = document.getElementById('question-categories');
            if (!container) return;

            let html = '';
            
            Object.entries(CONFIG.LAYER_NAMES).forEach(([layerType, layerName]) => {
                const categories = appState.categories.filter(c => c.layer === layerType);
                if (categories.length > 0) {
                    html += `
                        <div class="category-group">
                            <h4>${layerName}</h4>
                            <div class="checkbox-group">
                                ${categories.map(category => `
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="categories" value="${category.id}">
                                        <span>${sanitizeHtml(category.name)}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        function saveQuestionFromModal(event) {
            event.preventDefault();
            
            // 自定義驗證分類選擇
            const selectedCategories = document.querySelectorAll('input[name="categories"]:checked');
            
            const isValid = validateForm('question-form', {
                text: {
                    required: true,
                    requiredMessage: '請輸入題目內容',
                    validator: (value) => value.trim().length >= 5,
                    validatorMessage: '題目內容至少需要5個字元'
                }
            });

            if (selectedCategories.length === 0) {
                showFormError('question-categories', '請至少選擇一個分類');
                return;
            }

            if (!isValid) return;

            try {
                showLoading();
                
                const form = document.getElementById('question-form');
                const formData = new FormData(form);
                
                const questionData = {
                    text: formData.get('text').trim(),
                    categoryIds: Array.from(selectedCategories).map(cb => cb.value),
                    isReligious: formData.has('isReligious')
                };

                if (appState.currentEditingQuestion) {
                    // 更新題目
                    const questions = getQuestions();
                    const index = questions.findIndex(q => q.id === appState.currentEditingQuestion.id);
                    if (index !== -1) {
                        questions[index] = { ...questions[index], ...questionData };
                        saveQuestions(questions);
                        showToast('題目已更新', 'success');
                    }
                } else {
                    // 新增題目
                    const newQuestion = {
                        id: generateId(),
                        ...questionData,
                        order: getNextQuestionOrder()
                    };
                    
                    const questions = getQuestions();
                    questions.push(newQuestion);
                    saveQuestions(questions);
                    showToast('題目已新增', 'success');
                }

                loadData();
                render();
                hideAllModals();

            } catch (error) {
                console.error('儲存題目失敗:', error);
                showToast('儲存題目失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function deleteQuestion(questionId) {
            const question = appState.questions.find(q => q.id === questionId);
            if (!question) {
                showToast('找不到指定的題目', 'error');
                return;
            }

            if (!confirm(`確定要刪除題目「${question.text}」嗎？`)) return;

            try {
                showLoading();
                
                const questions = getQuestions();
                const filtered = questions.filter(q => q.id !== questionId);
                saveQuestions(filtered);
                
                loadData();
                render();
                
                showToast('題目已刪除', 'success');

            } catch (error) {
                console.error('刪除題目失敗:', error);
                showToast('刪除題目失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function getNextQuestionOrder() {
            return appState.questions.length > 0 ? Math.max(...appState.questions.map(q => q.order)) + 1 : 1;
        }

        // ===== 預覽和版本管理 =====
        
        function renderPreview() {
            const container = document.getElementById('preview-pane');
            if (!container) return;

            let questions = [...appState.questions];

            if (appState.previewMode === 'RANDOM_ALL') {
                questions = shuffleArray(questions);
            } else {
                questions.sort((a, b) => a.order - b.order);
            }

            const html = `
                <div class="preview-header">
                    <h3>問卷預覽</h3>
                    <div class="preview-info">
                        <span>共 ${questions.length} 題</span>
                        <span>模式: ${appState.previewMode === 'RANDOM_ALL' ? '隨機' : '分類順序'}</span>
                    </div>
                </div>
                <div class="preview-intro">
                    ${CONFIG.SURVEY_INTRO_TEXT.replace(/\n/g, '<br>')}
                </div>
                <div class="preview-questions">
                    ${questions.map((question, index) => `
                        <div class="preview-question fade-in">
                            <div class="question-number">${index + 1}.</div>
                            <div class="question-text">${sanitizeHtml(question.text)}</div>
                            <div class="scale-options">
                                ${CONFIG.SCALE_OPTIONS.map(option => `
                                    <label class="scale-option">
                                        <input type="radio" name="preview-q${question.id}" value="${option.value}" disabled>
                                        <span class="scale-label">${option.value}. ${option.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.innerHTML = html;
        }

        function togglePreviewMode() {
            const checkbox = document.getElementById('toggle-preview-random');
            appState.previewMode = checkbox.checked ? 'RANDOM_ALL' : 'BY_CATEGORY';
            
            const settings = getFromStorage(CONFIG.STORAGE_KEYS.SETTINGS) || {};
            settings.previewMode = appState.previewMode;
            saveToStorage(CONFIG.STORAGE_KEYS.SETTINGS, settings);
            
            renderPreview();
        }

        function renderVersions() {
            const container = document.getElementById('version-list');
            if (!container) return;

            const versions = [...appState.versions].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            const html = versions.map(version => `
                <div class="version-item fade-in">
                    <div class="version-info">
                        <div class="version-name">${sanitizeHtml(version.name)}</div>
                        <div class="version-date">${formatDate(new Date(version.createdAt))}</div>
                    </div>
                    <div class="version-actions">
                        <button class="btn-small" onclick="loadVersion('${version.id}')">載入</button>
                        <button class="btn-small btn-danger" onclick="deleteVersion('${version.id}')">刪除</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">📋</div>尚無儲存的版本</div>';
        }

        function saveVersion() {
            if (appState.questions.length === 0) {
                showToast('請先新增題目再儲存版本', 'warning');
                return;
            }

            const versionName = prompt(
                '請輸入版本名稱:',
                `版本 ${formatDate(new Date(), 'YYYY-MM-DD HH:mm')}`
            );
            
            if (!versionName) return;

            try {
                showLoading();
                
                const version = {
                    id: generateId(),
                    name: versionName,
                    createdAt: new Date().toISOString(),
                    settings: {
                        orderMode: appState.previewMode,
                        includeReligious: 'ALL'
                    },
                    snapshot: {
                        categories: getCategories(),
                        questions: getQuestions()
                    }
                };
                
                const versions = getVersions();
                versions.push(version);
                saveVersions(versions);
                
                loadData();
                renderVersions();
                
                showToast(`版本「${version.name}」已儲存`, 'success');
                
            } catch (error) {
                console.error('儲存版本失敗:', error);
                showToast('儲存版本失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function showVersionModal() {
            renderVersionsInModal();
            showModal('version-modal');
        }

        function renderVersionsInModal() {
            const container = document.getElementById('version-list-modal');
            if (!container) return;

            const versions = [...appState.versions].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            const html = versions.map(version => `
                <div class="version-item">
                    <div class="version-info">
                        <div class="version-name">${sanitizeHtml(version.name)}</div>
                        <div class="version-date">${formatDate(new Date(version.createdAt))}</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                            ${version.snapshot.questions.length} 題目, ${version.snapshot.categories.length} 分類
                        </div>
                    </div>
                    <div class="version-actions">
                        <button class="btn-small" onclick="loadVersion('${version.id}')">載入</button>
                        <button class="btn-small btn-danger" onclick="deleteVersion('${version.id}')">刪除</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">📋</div>尚無儲存的版本</div>';
        }

        function loadVersion(versionId) {
            if (!confirm('載入版本將覆蓋當前的分類和題目，確定要繼續嗎？')) return;

            try {
                showLoading();
                
                const versions = getVersions();
                const version = versions.find(v => v.id === versionId);
                
                if (!version) {
                    throw new Error('找不到指定的版本');
                }
                
                saveCategories(version.snapshot.categories);
                saveQuestions(version.snapshot.questions);
                
                loadData();
                render();
                hideAllModals();
                
                showToast(`版本「${version.name}」已載入`, 'success');
                
            } catch (error) {
                console.error('載入版本失敗:', error);
                showToast('載入版本失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function deleteVersion(versionId) {
            const versions = getVersions();
            const version = versions.find(v => v.id === versionId);
            
            if (!version) {
                showToast('找不到指定的版本', 'error');
                return;
            }

            if (!confirm(`確定要刪除版本「${version.name}」嗎？`)) return;

            try {
                showLoading();
                
                const filtered = versions.filter(v => v.id !== versionId);
                saveVersions(filtered);
                
                loadData();
                renderVersions();
                renderVersionsInModal();
                
                showToast('版本已刪除', 'success');

            } catch (error) {
                console.error('刪除版本失敗:', error);
                showToast('刪除版本失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // ===== 資料管理 =====
        
  /*      function exportLibrary() {
            try {
                const data = {
                    categories: getCategories(),
                    questions: getQuestions(),
                    versions: getVersions(),
                    exportedAt: new Date().toISOString(),
                    version: '1.0.0'
                };
                
                const filename = `spiritual-survey-library-${formatDate(new Date(), 'YYYY-MM-DD')}.json`;
                downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
                showToast('題庫已匯出', 'success');
                
            } catch (error) {
                console.error('匯出題庫失敗:', error);
                showToast('匯出題庫失敗: ' + error.message, 'error');
            }
        }

        */

        function showImportModal() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    importLibrary(file);
                }
            };
            
            input.click();
        }

        async function importLibrary(file) {
            try {
                showLoading();
                
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!confirm('匯入將覆蓋現有的分類和題目，確定要繼續嗎？')) return;
                
                if (data.categories && Array.isArray(data.categories)) {
                    saveCategories(data.categories);
                }
                if (data.questions && Array.isArray(data.questions)) {
                    saveQuestions(data.questions);
                }
                if (data.versions && Array.isArray(data.versions)) {
                    saveVersions(data.versions);
                }
                
                loadData();
                render();
                
                showToast('題庫已匯入', 'success');
                
            } catch (error) {
                console.error('匯入題庫失敗:', error);
                showToast('匯入題庫失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function exportResponses() {
            try {
                const responses = getResponses();
                
                if (responses.length === 0) {
                    showToast('沒有回覆資料可匯出', 'warning');
                    return;
                }
                
                const filename = `spiritual-survey-responses-${formatDate(new Date(), 'YYYY-MM-DD')}.json`;
                downloadFile(JSON.stringify(responses, null, 2), filename, 'application/json');
                
                showToast('回覆資料已匯出', 'success');
                
            } catch (error) {
                console.error('匯出回覆失敗:', error);
                showToast('匯出回覆失敗: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const stats = {
                categories: appState.categories.length,
                questions: appState.questions.length,
                versions: appState.versions.length,
                responses: getResponses().length
            };

            const elements = {
                'stats-categories': stats.categories,
                'stats-questions': stats.questions,
                'stats-versions': stats.versions,
                'stats-responses': stats.responses
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        }

        // ===== 問卷作答功能 =====
        
        function generateSurvey() {
            if (appState.questions.length === 0) {
                showToast('請先新增題目', 'error');
                return;
            }

            try {
                showLoading();
                
                const versionName = `問卷版本 ${formatDate(new Date(), 'YYYY-MM-DD HH:mm:ss')}`;
                const settings = {
                    orderMode: appState.previewMode,
                    includeReligious: 'ALL'
                };
                
                const version = {
                    id: generateId(),
                    name: versionName,
                    createdAt: new Date().toISOString(),
                    settings,
                    snapshot: {
                        categories: getCategories(),
                        questions: getQuestions()
                    }
                };
                
                const versions = getVersions();
                versions.push(version);
                saveVersions(versions);
                
                appState.currentVersion = version;
                
                showPage('survey');
                showToast('問卷已生成', 'success');
                
            } catch (error) {
                console.error('生成問卷失敗:', error);
                showToast('生成問卷失敗: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function initSurvey() {
            // 獲取版本 ID
            const urlParams = new URLSearchParams(window.location.search);
            const versionId = urlParams.get('versionId');
            
            if (versionId) {
                const versions = getVersions();
                appState.currentVersion = versions.find(v => v.id === versionId);
            }
            
            if (!appState.currentVersion) {
                // 使用最新版本或建立臨時版本
                const versions = getVersions();
                if (versions.length > 0) {
                    appState.currentVersion = versions[versions.length - 1];
                } else {
                    // 建立臨時版本
                    appState.currentVersion = {
                        id: 'temp',
                        name: '臨時版本',
                        settings: { orderMode: 'BY_CATEGORY' },
                        snapshot: {
                            categories: getCategories(),
                            questions: getQuestions()
                        }
                    };
                }
            }

            renderSurvey();
        }

        function renderSurvey() {
            // 顯示引導語
            const introElement = document.getElementById('intro-text');
            if (introElement) {
                introElement.innerHTML = CONFIG.SURVEY_INTRO_TEXT.replace(/\n/g, '<br>');
            }
            
            // 設定檢測日期預設值
            setDefaultTestDate();

            // 渲染題目
            renderSurveyQuestions();
            
            // 載入已保存的部分答案
            loadPartialAnswers();
        }

        function renderSurveyQuestions() {
            const container = document.getElementById('survey-questions');
            if (!container || !appState.currentVersion) return;

            let questions = [...appState.currentVersion.snapshot.questions];

            // 根據設定排序
            if (appState.currentVersion.settings.orderMode === 'RANDOM_ALL') {
                questions = shuffleArray(questions);
            } else {
                questions.sort((a, b) => a.order - b.order);
            }

            const html = questions.map((question, index) => `
                <div class="survey-question fade-in">
                    <div class="survey-question-number">${index + 1}.</div>
                    <div class="survey-question-text">${sanitizeHtml(question.text)}</div>
                    <div class="survey-scale">
                        ${CONFIG.SCALE_OPTIONS.map(option => `
                            <div class="survey-scale-option" onclick="selectAnswer('${question.id}', ${option.value})">
                                <div class="survey-scale-value">${option.value}</div>
                                <div class="survey-scale-label">${option.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            updateProgress();
        }

        function selectAnswer(questionId, value) {
            appState.surveyAnswers[questionId] = value;
            
            // 更新 UI
            document.querySelectorAll(`[onclick*="${questionId}"]`).forEach(option => {
                option.classList.remove('selected');
            });
            
            event.target.closest('.survey-scale-option').classList.add('selected');
            
            updateProgress();
            
            // 自動保存部分答案
            savePartialAnswers(appState.surveyAnswers);
            showAutoSaveIndicator('saved');
        }

        function updateProgress() {
            if (!appState.currentVersion) return;
            
            const totalQuestions = appState.currentVersion.snapshot.questions.length;
            const answeredQuestions = Object.keys(appState.surveyAnswers).length;
            const progress = (answeredQuestions / totalQuestions) * 100;
            
            const progressFill = document.getElementById('progress-fill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            // 顯示個人資料表單和保存選項
            const profileForm = document.getElementById('profile-form');
            const saveOptions = document.getElementById('save-options');
            
            if (answeredQuestions > 0) {
                if (saveOptions) {
                    saveOptions.classList.remove('hidden');
                }
            }
            
            if (answeredQuestions === totalQuestions && profileForm) {
                profileForm.classList.remove('hidden');
                profileForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function loadPartialAnswers() {
            const partialAnswers = getPartialAnswers();
            if (Object.keys(partialAnswers).length > 0) {
                appState.surveyAnswers = partialAnswers;
                
                // 更新 UI
                Object.entries(partialAnswers).forEach(([questionId, value]) => {
                    const option = document.querySelector(`[onclick*="${questionId}"][onclick*="${value}"]`);
                    if (option) {
                        option.classList.add('selected');
                    }
                });
                
                updateProgress();
                showToast('已載入之前保存的答案', 'info');
            }
        }

        function setDefaultTestDate() {
            const testDateInput = document.querySelector('input[name="testDate"]');
            if (testDateInput) {
                testDateInput.value = formatDate(new Date(), 'YYYY-MM-DD');
            }
        }

        // ===== 多種保存方式 =====
        
        function submitSurvey() {
            try {
                // 檢查是否完成作答
                const totalQuestions = appState.currentVersion.snapshot.questions.length;
                const answeredQuestions = Object.keys(appState.surveyAnswers).length;
                
                if (answeredQuestions < totalQuestions) {
                    showToast('請完成所有題目', 'error');
                    return;
                }

                // 驗證個人資料表單
                const isValid = validateForm('profile-form', {
                    name: { required: true, requiredMessage: '請輸入姓名' },
                    birth: { required: true, requiredMessage: '請選擇生日' },
                    gender: { required: true, requiredMessage: '請選擇性別' },
                    nationality: { required: true, requiredMessage: '請輸入國籍' },
                    city: { required: true, requiredMessage: '請輸入居住城市' },
                    profession: { required: true, requiredMessage: '請輸入職業' },
                    education: { required: true, requiredMessage: '請選擇教育程度' },
                    marital: { required: true, requiredMessage: '請選擇婚姻狀況' },
                    religion: { required: true, requiredMessage: '請選擇宗教信仰' },
                    living: { required: true, requiredMessage: '請選擇居住狀況' },
                    testDate: { required: true, requiredMessage: '請選擇檢測日期' }
                });

                if (!isValid) {
                    showToast('請填寫所有必填欄位', 'error');
                    return;
                }

                showLoading();

                // 收集個人資料
                const profileForm = document.getElementById('profile-form');
                const formData = new FormData(profileForm);
                const demographics = {};
                
                for (let [key, value] of formData.entries()) {
                    demographics[key] = value.trim();
                }

                // 建立回覆記錄
                const response = {
                    id: generateId(),
                    versionId: appState.currentVersion.id,
                    answers: Object.entries(appState.surveyAnswers).map(([questionId, value]) => ({
                        questionId,
                        value
                    })),
                    demographics,
                    createdAt: new Date().toISOString()
                };

                // 計算分析結果
//                const analysis = calculateAnalysis(response);
//                response.aggregates = analysis;

                // 儲存回覆
                saveResponse(response);
//
                // 清除部分答案
//                savePartialAnswers({});

                // 顯示結果
  //              displayResults(response);
                
  //              showToast('問卷提交成功', 'success');

   //         } catch (error) {
   //             console.error('提交問卷失敗:', error);
  //              showToast('提交問卷失敗: ' + error.message, 'error');
//            } finally {
 //               hideLoading();
//            }
  //      }

/*        function savePartialAnswers() {
            try {
                savePartialAnswers(appState.surveyAnswers);
                showToast('當前答案已保存', 'success');
                showAutoSaveIndicator('saved');
            } catch (error) {
                console.error('保存答案失敗:', error);
                showToast('保存答案失敗: ' + error.message, 'error');
                showAutoSaveIndicator('error');
            }
        }

        */

        /*

        function exportAnswersAsJSON() {
            try {
                const data = {
                    answers: appState.surveyAnswers,
                    answeredCount: Object.keys(appState.surveyAnswers).length,
                    totalQuestions: appState.currentVersion ? appState.currentVersion.snapshot.questions.length : 0,
                    exportedAt: new Date().toISOString()
                };
                
                const filename = `survey-answers-${formatDate(new Date(), 'YYYY-MM-DD-HHmmss')}.json`;
                downloadFile(JSON.stringify(data, null, 2), filename, 'application/json');
                showToast('答案已匯出為 JSON', 'success');
            } catch (error) {
                console.error('匯出答案失敗:', error);
                showToast('匯出失敗: ' + error.message, 'error');
            }
        }

        function copyAnswersToClipboard() {
            try {
                const data = {
                    answers: appState.surveyAnswers,
                    answeredCount: Object.keys(appState.surveyAnswers).length,
                    totalQuestions: appState.currentVersion ? appState.currentVersion.snapshot.questions.length : 0,
                    copiedAt: new Date().toISOString()
                };
                
                const text = JSON.stringify(data, null, 2);
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('答案已複製到剪貼簿', 'success');
                    }).catch(() => {
                        fallbackCopyToClipboard(text);
                    });
                } else {
                    fallbackCopyToClipboard(text);
                }
            } catch (error) {
                console.error('複製答案失敗:', error);
                showToast('複製失敗: ' + error.message, 'error');
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('答案已複製到剪貼簿', 'success');
            } catch (err) {
                showToast('複製失敗，請手動複製', 'error');
            }
            document.body.removeChild(textArea);
        }

        // ===== 自動保存功能 =====
        
        function startAutoSave() {
            if (appState.autoSaveTimer) {
                clearInterval(appState.autoSaveTimer);
            }
            
            appState.autoSaveTimer = setInterval(() => {
                if (Object.keys(appState.surveyAnswers).length > 0) {
                    showAutoSaveIndicator('saving');
                    
                    setTimeout(() => {
                        try {
                            savePartialAnswers(appState.surveyAnswers);
                            showAutoSaveIndicator('saved');
                        } catch (error) {
                            console.error('自動保存失敗:', error);
                            showAutoSaveIndicator('error');
                        }
                    }, 500);
                }
            }, CONFIG.AUTO_SAVE_INTERVAL);
        }

        // ===== 結果分析和顯示 =====
        
        function calculateAnalysis(response) {
            const categories = appState.currentVersion.snapshot.categories;
            const questions = appState.currentVersion.snapshot.questions;
            const answers = response.answers;

            const analysis = {
                byDimension: {},
                overall: 0
            };

            // 計算各維度平均分
            const dimensionGroups = {
                facets: categories.filter(c => c.layer === 'FACETS_7'),
                indicators: categories.filter(c => c.layer === 'INDICATORS_10'),
                principles: categories.filter(c => c.layer === 'PRINCIPLES_7'),
                practices: categories.filter(c => c.layer === 'PRACTICES')
            };

            Object.entries(dimensionGroups).forEach(([groupName, groupCategories]) => {
                groupCategories.forEach(category => {
                    const categoryQuestions = questions.filter(q => 
                        q.categoryIds.includes(category.id)
                    );
                    
                    if (categoryQuestions.length > 0) {
                        const categoryAnswers = answers.filter(a => 
                            categoryQuestions.some(q => q.id === a.questionId)
                        );
                        
                        if (categoryAnswers.length > 0) {
                            const sum = categoryAnswers.reduce((total, answer) => total + answer.value, 0);
                            analysis.byDimension[category.name] = sum / categoryAnswers.length;
                        }
                    }
                });
            });

            // 計算總平均分
            const allScores = Object.values(analysis.byDimension);
            if (allScores.length > 0) {
                analysis.overall = allScores.reduce((sum, score) => sum + score, 0) / allScores.length;
            }

            return analysis;
        }

        function displayResults(response) {
            const resultPanel = document.getElementById('result-panel');
            if (resultPanel) {
                resultPanel.classList.remove('hidden');

                // 渲染各維度分數
                renderDimensionScores(response.aggregates);
                
                // 繪製圖表
                drawRadarChart(response.aggregates);
                
                // 顯示建議
                renderSuggestions(response.aggregates);
                
                // 儲存當前結果供匯出使用
                appState.currentResult = response;
                
                // 滾動到結果區域
                resultPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderDimensionScores(aggregates) {
            const categories = appState.currentVersion.snapshot.categories;
            
            // 七面向
            const facetsContainer = document.getElementById('facets-scores');
            if (facetsContainer) {
                const facets = categories.filter(c => c.layer === 'FACETS_7');
                facetsContainer.innerHTML = facets.map(facet => {
                    const score = aggregates.byDimension[facet.name] || 0;
                    return `
                        <div class="dimension-score">
                            <span class="dimension-name">${sanitizeHtml(facet.name)}</span>
                            <span class="dimension-value">${score.toFixed(1)}</span>
                        </div>
                    `;
                }).join('');
            }

            // 十指標
            const indicatorsContainer = document.getElementById('indicators-scores');
            if (indicatorsContainer) {
                const indicators = categories.filter(c => c.layer === 'INDICATORS_10');
                indicatorsContainer.innerHTML = indicators.map(indicator => {
                    const score = aggregates.byDimension[indicator.name] || 0;
                    return `
                        <div class="dimension-score">
                            <span class="dimension-name">${sanitizeHtml(indicator.name)}</span>
                            <span class="dimension-value">${score > 0 ? score.toFixed(1) : '未評'}</span>
                        </div>
                    `;
                }).join('');
            }

            // 七原則
            const principlesContainer = document.getElementById('principles-scores');
            if (principlesContainer) {
                const principles = categories.filter(c => c.layer === 'PRINCIPLES_7');
                principlesContainer.innerHTML = principles.map(principle => {
                    const score = aggregates.byDimension[principle.name] || 0;
                    return `
                        <div class="dimension-score">
                            <span class="dimension-name">${sanitizeHtml(principle.name)}</span>
                            <span class="dimension-value">${score.toFixed(1)}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function drawRadarChart(aggregates) {
            const canvas = document.getElementById('radar-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // 設定 canvas 尺寸
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 60;
            
            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 獲取七面向資料
            const categories = appState.currentVersion.snapshot.categories.filter(c => c.layer === 'FACETS_7');
            const data = categories.map(category => ({
                label: category.name,
                value: aggregates.byDimension[category.name] || 0
            }));
            
            const angleStep = (2 * Math.PI) / data.length;
            
            // 繪製背景網格
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 1; i <= 6; i++) {
                ctx.beginPath();
                const r = (radius * i) / 6;
                ctx.arc(centerX, centerY, r, 0, 2 * Math.PI);
                ctx.stroke();
                
                // 繪製分數標籤
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(i.toString(), centerX + r - 10, centerY - 5);
            }
            
            // 繪製軸線和標籤
            data.forEach((item, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // 軸線
                ctx.strokeStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // 標籤
                ctx.fillStyle = '#374151';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const labelX = centerX + Math.cos(angle) * (radius + 30);
                const labelY = centerY + Math.sin(angle) * (radius + 30);
                
                // 分行顯示長標籤
                const words = item.label.split('');
                if (words.length > 4) {
                    const line1 = words.slice(0, 4).join('');
                    const line2 = words.slice(4).join('');
                    ctx.fillText(line1, labelX, labelY - 8);
                    ctx.fillText(line2, labelX, labelY + 8);
                } else {
                    ctx.fillText(item.label, labelX, labelY);
                }
            });
            
            // 繪製數據多邊形
            ctx.strokeStyle = '#2563eb';
            ctx.fillStyle = 'rgba(37, 99, 235, 0.2)';
            ctx.lineWidth = 3;
            
            ctx.beginPath();
            data.forEach((item, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const r = (radius * item.value) / 6;
                const x = centerX + Math.cos(angle) * r;
                const y = centerY + Math.sin(angle) * r;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // 繪製數據點
            ctx.fillStyle = '#2563eb';
            data.forEach((item, index) => {
                const angle = index * angleStep - Math.PI / 2;
                const r = (radius * item.value) / 6;
                const x = centerX + Math.cos(angle) * r;
                const y = centerY + Math.sin(angle) * r;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // 顯示分數
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toFixed(1), x, y - 10);
            });
        }

        function renderSuggestions(aggregates) {
            const container = document.getElementById('suggestions-content');
            if (!container) return;
            
            const suggestions = [];
            
            Object.entries(aggregates.byDimension).forEach(([dimension, score]) => {
                let suggestion = '';
                
                if (score >= 4.5) {
                    suggestion = `您在「${dimension}」方面表現優良，建議繼續保持並可考慮引導他人。`;
                } else if (score >= 3.0) {
                    suggestion = `您在「${dimension}」方面具備基礎，可進一步在日常生活中練習相關原則。`;
                } else {
                    suggestion = `建議加強「${dimension}」方面的修養，從日常覺察開始，透過具體行動提升。`;
                }
                
                suggestions.push({ dimension, suggestion, score });
            });
            
            // 按分數排序，低分優先顯示
            suggestions.sort((a, b) => a.score - b.score);
            
            container.innerHTML = suggestions.map(item => `
                <div class="suggestion-item fade-in">
                    <div class="suggestion-dimension">${sanitizeHtml(item.dimension)} (${item.score.toFixed(1)}分)</div>
                    <div class="suggestion-text">${sanitizeHtml(item.suggestion)}</div>
                </div>
            `).join('');
        }

        function exportResultAsJSON() {
            if (!appState.currentResult) {
                showToast('沒有結果資料可匯出', 'warning');
                return;
            }

            try {
                const filename = `spiritual-survey-result-${formatDate(new Date(), 'YYYY-MM-DD-HHmmss')}.json`;
                downloadFile(JSON.stringify(appState.currentResult, null, 2), filename, 'application/json');
                showToast('結果已匯出為 JSON', 'success');
            } catch (error) {
                console.error('匯出 JSON 失敗:', error);
                showToast('匯出失敗: ' + error.message, 'error');
            }
        }

        function exportResultAsCSV() {
            if (!appState.currentResult) {
                showToast('沒有結果資料可匯出', 'warning');
                return;
            }

            try {
                const csvData = convertResponseToCSV(appState.currentResult);
                const filename = `spiritual-survey-result-${formatDate(new Date(), 'YYYY-MM-DD-HHmmss')}.csv`;
                downloadFile(csvData, filename, 'text/csv;charset=utf-8;');
                showToast('結果已匯出為 CSV', 'success');
            } catch (error) {
                console.error('匯出 CSV 失敗:', error);
                showToast('匯出失敗: ' + error.message, 'error');
            }
        }

        function convertResponseToCSV(response) {
            const headers = [
                'ID', '版本ID', '作答時間', '姓名', '生日', '性別', '國籍', '城市',
                '職業', '教育程度', '婚姻狀況', '宗教信仰', '居住狀況', '檢測日期'
            ];
            
            // 添加題目標題
            response.answers.forEach((answer, index) => {
                headers.push(`Q${index + 1}`);
            });
            
            // 添加維度分數
            Object.keys(response.aggregates.byDimension).forEach(dimension => {
                headers.push(`${dimension}_平均分`);
            });
            headers.push('總平均分');
            
            // 建立資料行
            const row = [
                response.id,
                response.versionId,
                response.createdAt,
                response.demographics.name || '',
                response.demographics.birth || '',
                response.demographics.gender || '',
                response.demographics.nationality || '',
                response.demographics.city || '',
                response.demographics.profession || '',
                response.demographics.education || '',
                response.demographics.marital || '',
                response.demographics.religion || '',
                response.demographics.living || '',
                response.demographics.testDate || ''
            ];
            
            // 添加答案
            response.answers.forEach(answer => {
                row.push(answer.value);
            });
            
            // 添加維度分數
            Object.values(response.aggregates.byDimension).forEach(score => {
                row.push(score.toFixed(2));
            });
            row.push(response.aggregates.overall.toFixed(2));
            
            // 組合 CSV
            return [headers, row]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        // ===== 頁面載入完成後初始化 =====
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('DOM 載入完成，開始初始化應用程式');
                await initApp();
                console.log('應用程式初始化完成');
            } catch (error) {
                console.error('應用程式初始化失敗:', error);
                
                // 顯示錯誤訊息
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #fee2e2;
                    border: 1px solid #fecaca;
                    color: #991b1b;
                    padding: 2rem;
                    border-radius: 8px;
                    max-width: 400px;
                    text-align: center;
                    z-index: 10000;
                `;
                errorDiv.innerHTML = `
                    <h3>系統初始化失敗</h3>
                    <p style="margin: 1rem 0;">${error.message}</p>
                    <button onclick="location.reload()" style="padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        重新載入
                    </button>
                `;
                document.body.appendChild(errorDiv);
            }
        });

        // 全域錯誤處理
        window.addEventListener('error', (event) => {
            console.error('全域錯誤:', event.error);
            showToast('系統發生錯誤，請重新整理頁面', 'error');
        });

        // 未處理的 Promise 拒絕
        window.addEventListener('unhandledrejection', (event) => {
            console.error('未處理的 Promise 拒絕:', event.reason);
            showToast('系統發生異步錯誤', 'error');
        });

        // 頁面卸載時清理
        window.addEventListener('beforeunload', () => {
            if (appState.autoSaveTimer) {
                clearInterval(appState.autoSaveTimer);
            }
        });


        */
    </script>


</body></html>
